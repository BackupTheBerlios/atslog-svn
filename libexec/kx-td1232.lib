# ATSlog version @version@ build @buildnumber@ www.atslog.dp.ua  
# Copyright (C) 2003 Denis CyxoB www.yamiyam.dp.ua
#
# Разбираем строки текстового-лог файла для АТС Panasonic KX-TD1232

sub parsecurcalls() {
    while ($str=<>)
    {
        $stringNumber++;
        if ($str =~ /^.*?(\d+)\/\s??(\d+)\/\s??(\d+)\s+(\d+)\:(\d+)(['AM'|'PM']{2})\s+(\d+)\s+(\d+)\s+(.*?)\s+(\d*)\s+(\d+)\:(\d+)\'(\d+)\s+(\w*).+$/){
	    unitecurcalls();
        }else{
	    #print("$stringNumber\n");
	    if ($vars{debug} =~ /yes/i){
		if ($str !~ /^\s*$/){
		    print $str;
		};
	    };
        };
    };
};

sub unitecurcalls() {

    $Month = $1;

    $Day=$2;

    $Year=$3+2000;

    $CallHour=&AmPmTo24($4,$6);

    if($14 eq 'FW' or $14 eq 'TR'){
	$Forwarded =1;
    }else{
        $Forwarded =0;
    };

    $CallMinute=$5;

    $Internally=$7;

    $CO=$8;
    
    $Duration = (($11*60*60)+($12*60)+$13);

    $forIncoming=$9;

    $earlyIncoming=$10;

    $TimeOfCall = "'$Year-$Month-$Day $CallHour\:$CallMinute\:00'";

    if($forIncoming =~ /<INCOMING>\s*/){
	$Way='1';
# Если АОН на АТС может определять номер входящего звонка.
	$Number=$earlyIncoming;
	$Number=~ s/\D+//;
	if ($Number eq ""){
	    $Number = '0'; # Not Specified
	}
    }else{
	$Way='2';
	$Number=$forIncoming;
	$forIncoming =~ s/\D+//;
	$Number = substr($forIncoming,0,100);
    };

    if ($TimeOfCall ne ""){
# Для проверки наличия хоть одной запись звонков подлежащей
# записи в db.
	$callsCount++;
    }
    #print("$stringNumber $TimeOfCall $Forwarded $Internally $CO $Way $Number $Duration\n");
    $ins_query = "INSERT INTO `calls` (`TimeOfCall`, `Forwarded`,`Internally`,`CO`, `Way` , `Number`, `Duration`) VALUES  (".$TimeOfCall.", '$Forwarded', '$Internally', '$CO', '$Way', '$Number', '$Duration');";
    $dbh->Query($ins_query);

}

1;
