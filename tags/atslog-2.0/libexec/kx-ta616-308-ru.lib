# ATSlog version @version@ build @buildnumber@ www.atslog.dp.ua
# Copyright (C) 2003 Denis CyxoB www.yamiyam.dp.ua
#
# Разбираем строки текстового-лог файла для
# АТС Panasonic KX-TA616RU, Panasonic KX-TA308RU и Panasonic KX-TA308

sub parsecurcalls() {
    while ($str=<>)
    {
        $stringnumber++;
        if ($str =~ /^.*?(\d+)\/\s??(\d+)\/\s??(\d+)\s*([\**|\s*])\s*(\d+)\:(\d+)([A|P]M)\s+(\d+)\s+(\d+)\s+(.*?)\s+(\d+)\:(\d+)\'(\d+)\".+$/){
	    unitecurcalls();
        }else{
	    #print("$stringnumber\n");
	    if ($vars{debug} =~ /yes/i){
		if ($str !~ /^$/){
		    print $str;
		};
	    };
        };
    };
};

sub unitecurcalls() {

    $Month = $1;

    $Day=$2;

    $Year=$3+2000;

    $CallHour=&AmPmTo24($5,$7);

    if($4 eq '*'){
	$forwarded =1;
    }else{
        $forwarded =0;
    };

    $CallMinute=$6;

    $internally=$8;

    $co=$9;

    $forIncoming=$10;

    $duration = (($11*60*60)+($12*60)+$13);

    $timeofcall = "$Year-$Month-$Day $CallHour\:$CallMinute\:00";
	
    if($forIncoming =~ /<\s*[[a-z]|\s]*\s*>\s*/i){
	$way='1';
	$number=0; # Not Specified
    }else{
	$way='2';
	$forIncoming =~ s/\D+//;
	$number = substr($forIncoming,0,100);
    };

    if ($timeofcall ne ""){
# Для проверки наличия хоть одной запись звонков подлежащей
# записи в db.
	$callsCount++;
    }
#    print("$stringnumber $timeofcall $forwarded $internally $co $way $number $duration\n");
    $ins_query = "INSERT INTO calls (timeofcall, forwarded,internally,co,way,number, duration) VALUES  ('$timeofcall', '$forwarded', '$internally', '$co', '$way', '$number', '$duration');";
    $sth = $dbh->prepare($ins_query);
    $sth->execute;
}

1;
