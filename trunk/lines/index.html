<?php


 /*                              
                                  
    Параметры                     
                                     
 */                              
                                      
include("../include/set/conf.inc");

 /* 

    Функции

 */
 
include('../include/set/functions.php');

// Обработаем передаваемые скрипту переменные на тему безопасности и совместимости с
// работой в режиме register_globals
//
import_request_variables("gPc", "rvar_");
if (!empty($rvar_debug))		$debug     = translateHtml($rvar_debug);
if (!empty($rvar_lang))                 $lang     = translateHtml($rvar_lang);
if (!empty($rvar_color)) $color=translateHtml($rvar_color);

	// Load language
	LanguageSetup($lang);
	
	// Colors scheme   
	ColorSetup($color);

	connect_to_db();

	if (!checkpass()) {
	    nopass();
	}
	if (!hasprivilege("access", false)) {
    	    nopass();
	}

	hasprivilege("parameters", true);

	if ($_POST["add"])
	{
		if ($_POST["CO"] == "")
		{
			header("Location: ?msg=3");
			die;
		}
		if ($_POST["Name"] == "")
		{
			header("Location: ?msg=2");
			die;
		}
		if(!$demoMode){
		    $conn->Execute("insert into co (CO, Name) values ('".$_POST["CO"]."', '".$_POST["Name"]."')");
		}
		header("Location: ?");
		die;
	}
	else if ($_POST["edit"])
	{
		if ($_POST["CO"] == "")
		{
			header("Location: ?msg=3");
			die;
		}
		if ($_POST["Name"] == "")
		{
			header("Location: ?msg=2");
			die;
		}
		$q4="SELECT 0 FROM co WHERE CO = '".$_POST["edit"]."'";
		$res = $conn->Execute($q4);
		if (isset($res->fields[0])){
		    if(!$demoMode){
			$conn->Execute("update co set CO='".$_POST["CO"]."', Name = '".$_POST["Name"]."' where CO = '".$_POST["edit"]."'");
		    }
		}else{
		    if(!$demoMode){
			$conn->Execute("insert into co (CO, Name) values ('".$_POST["CO"]."', '".$_POST["Name"]."')");
		    }
		}
		header("Location: ?");
		die;
	}
	else if ($_GET["delete"])
	{
		$q5="delete from co where CO = '".$_GET["delete"]."'";
		if(!$demoMode){
		    $conn->Execute($q5);
		}
		
		header("Location: ?");
		die;
	}
$title=strtr($GUI_LANG['ParametersOfLines'],$GUI_LANG['UpperCase'],$GUI_LANG['LowerCase']);
if(empty($export)) include("../include/set/header.html");
?>
<table cellpadding=0 cellspacing=0 border=0 width="100%">
    <tr><td colspan=2><?
$user="";
if(IsDefaultPass($_SERVER['PHP_AUTH_USER'])) echo "<font color=red><b>".$GUI_LANG['ChangeDefaultAdminPassword']."</b></font><br>&nbsp;";
?></td>
    </tr>
    <tr>
<?
    menucomplit("lines");
?>
	<td width=50%>&nbsp;</td>
    </tr>
</table>
	</td>
    </tr>
    <tr>
	<TD>
<?
    echo $GUI_LANG['Abonent'].": ".$authrow["Login"]." (".$authrow["Lastname"]." ".$authrow["Firstname"]." ".$authrow["Secondname"].")";
?>
	</td>
    </tr>
    <tr>
	<td>
<?
	echo "<H1>".$GUI_LANG['Lines'].":</H1>";
	switch ($_GET["msg"])
	{
		case 2:
			echo "<div><font color=red><b>".$GUI_LANG['EnterTheDescriptionOfExternalLine']."</b></font></div><br>";
			break;
		case 3:
			echo "<div><font color=red><b>".$GUI_LANG['EnterALineNumber']."</b></font></div><br>";
			break;
	}
	$q2="SELECT CO, Name from co order by CO";
	if($debug) echo $q2."<br>";

	$q1="SELECT CO from calls group by CO";
	if($debug) echo $q1."<br>";

	$res1 = $conn->Execute($q1);
	if ($res1 && $res1->RecordCount() > 0) {
	    while ($arr1 = $res1->FetchRow()){
		$allIntern[]=$arr1[0];
	    }
	}
	
	$conn->setFetchMode(ADODB_FETCH_NUM);
	$res = $conn->Execute($q2); 
	if ($res && $res->RecordCount() > 0) { 
	
	    while (!$res->EOF) {
		$allRows[]=$res->fields;
		$res->MoveNext();
	    }
	}

        if(!empty($allIntern)){
	    while (list($k, $v) = each($allIntern)) {
		if(!empty($allRows)){
		    reset($allRows);
		    while (list($ke, $va) = each($allRows)) {
			if ($v==$va[0]){
			    $dobavit=FALSE;
			    break;
			}else{
		    	    $dobavit=TRUE;
			}
		    }
		}else{
		    $dobavit=TRUE;
		}
		if($dobavit){
	    	    $tmpArr=array($v);
	    	    $allRows[]=$tmpArr;
		}
	    }
	}

	if(!empty($allRows)){
	    reset($allRows);
	    ksort($allRows);
	}
	echo "
	<table cellspacing=0 cellpadding=1 border=0>
	    <TR ".$COLORS['BaseBorderTableBgcolor'].">
		<td>
	<table cellspacing=1 cellpadding=4 border=0><TR ".$COLORS['BaseTablesBgcolor']."><TH>&nbsp;</TH><TH>".$GUI_LANG['ExternalLines']."</TH><TH>".$GUI_LANG['Description']."</TH><TH>&nbsp;</TH>";
	if(!empty($allRows)){
	    while (list($key, $row) = each($allRows))
	    {

		echo "\n<TR ".$COLORS['BaseTrBgcolor']."><TD>";
		if ($_GET["edit"] == $row[0])
		{
			echo "<IMG SRC=\"../include/img/rowselected.gif\" WIDTH=19 HEIGHT=18></TD>\n";
			echo "<TD><FORM METHOD=POST STYLE=\"margin:0\"><INPUT TYPE=\"text\" NAME=\"CO\" VALUE=\"".htmlspecialchars($row[0])."\" SIZE=5></TD>\n";
			echo "<TD><INPUT TYPE=\"text\" NAME=\"Name\" VALUE=\"".htmlspecialchars($row[1])."\" SIZE=30></TD>\n";
			echo "<TD><INPUT TYPE=\"hidden\" NAME=\"edit\" VALUE=\"".$row[0]."\"><INPUT TYPE=IMAGE WIDTH=16 HEIGHT=16 SRC=\"../include/img/save.gif\" ALT=\"".$GUI_LANG['Save']."\" onclick=\"submit();\" style=\"cursor:hand;\"><IMG WIDTH=16 HEIGHT=16 src=\"../include/img/undo.gif\" alt=\"".$GUI_LANG['Cancel']."\" onclick=\"window.location = '?';\" style=\"cursor:hand;\"></FORM></TD>\n";
		}
		else
		{
			echo "<IMG WIDTH=19 HEIGHT=18 SRC=\"../include/img/row.gif\"></TD>";
			echo "<TD>".htmlspecialchars($row[0])."</TD>\n";

			echo "<TD>".htmlspecialchars($row[1])."</TD>";
			echo "<TD><IMG WIDTH=16 HEIGHT=16 HSPACE=2 VSPACE=2 SRC=\"../include/img/button_edit.png\" ALT=\"".$GUI_LANG['Edit']."\" onclick=\"window.location = '?edit=".$row[0]."';\" style=\"cursor:hand;\">";
			echo "<IMG WIDTH=16 HEIGHT=16 HSPACE=2 VSPACE=2 SRC=\"../include/img/button_drop.png\" ALT=\"".$GUI_LANG['Delete']."\" onclick=\"if (window.confirm('".$GUI_LANG['DeleteDescriptionOfExternalLine']." ".$row[0]."?')) window.location = '?delete=".$row[0]."';\" style=\"cursor:hand;\"></TD>";
		}
		echo "\n</TR>";
	    }
	}
	echo "<TR ".$COLORS['BaseTrBgcolor']."><TD><IMG WIDTH=19 HEIGHT=18 SRC=\"../include/img/rownew.gif\"><FORM METHOD=POST STYLE=\"margin:0\"></TD>";
	echo "<TD><INPUT TYPE=\"text\" NAME=\"CO\" SIZE=5></TD>";
	echo "<TD><INPUT TYPE=\"text\" NAME=\"Name\" SIZE=30></TD>";
	echo "<TD><INPUT TYPE=\"hidden\" NAME=\"add\" VALUE=\"1\"><INPUT TYPE=IMAGE WIDTH=16 HEIGHT=16 SRC=\"../include/img/new.gif\" ALT=\"".$GUI_LANG['Add']."\" onclick=\"submit();\" style=\"cursor:hand;\"></FORM></TD></TR>\n";
	echo "</TABLE>
		</td>
	    </tr>
	</table>
	";

    include("../include/set/footer.html");
?>