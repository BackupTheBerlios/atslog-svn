# ATSlog version @version@ build @buildnumber@ www.atslog.dp.ua  
# Copyright (C) 2003 Denis CyxoB www.yamiyam.dp.ua
# NX-820 text logfile processing Copyright by Mistic
#
# Разбираем строки текстового-лог файла для АТС Samsung NX-820

sub parsecurcalls() 
{
while ($str=<>)
{
    $stringNumber++;

    if ($str =~ /^.*?(\d+)\s+(\d+)\s+(\d+)\:(\d+)\s+(\d+)\:(\d+)\:\d+\s+(\d+)\:(\d+)\:(\d+)\s+(\S+).*$/)
    {
	unitecurcalls();
    }else
    {
	#print("$stringNumber\n");
	print $str if ($vars{debug} =~ /yes/i and $str !~ /^$/)
    };                                
};
};                                    

sub unitecurcalls() {

    $Internally=$1;
    $CO=$2;
    $Month=$3;
    $Day=$4;

    $Year = (localtime())[5];
    $Year += 1900;

    $CallHour=$5;
    $CallMinute=$6;
    $Duration = (($7*60*60)+($8*60)+$9);
    $TimeOfCall = "'$Year-$Month-$Day $CallHour\:$CallMinute\:00'";

    SWITCH: 
    {
	$10 =~ /xTRANSFER/ and  $Forwarded=3, last SWITCH;
	$10 =~ /TRANSFER/  and  $Forwarded=1, last SWITCH;
	$10 =~ /xINCOMING/ and  $Forwarded=2, last SWITCH;
	$Forwarded=0;
    }
										 

    if ($10 =~ /[x]*TRANSFER/ or $10 =~ /[x]*INCOMING/)
    {
	$Way='1';
	$Number=0; # Not Specified
    }else{
	$Way='2';
	$Outnumber = $10;
	$Outnumber =~ s/\D+//;
	$Number=substr($Outnumber,0,100);
    }
    

													
    if ($TimeOfCall ne "")
    {
	# Для проверки наличия хоть одной запись звонков подлежащей
	# записи в db.
	$callsCount++;
    }
    #print("Ok: $stringNumber $TimeOfCall $Forwarded $Internally $CO $Way $Number $Duration\n");
    $ins_query = "INSERT INTO `calls` (`TimeOfCall`, `Forwarded`,`Internally`,`CO`, `Way` , `Number`, `Duration`) VALUES  (".$TimeOfCall.", '$Forwarded', '$Internally', '$CO', '$Way', '$Number', '$Duration');";
    $dbh->Query($ins_query);
    
}
    
1;
											